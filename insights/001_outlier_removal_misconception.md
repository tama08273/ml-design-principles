# 外れ値除去の誤解：金融データのべき分布と対数変換

## 概要

機械学習の教科書では「外れ値は除去しましょう」と書かれています。

が、金融データのような実務データでは、外れ値は**重要な知見を持つ**ことが多くあります。
本ドキュメントは、「外れ値が何を意味するのか」を理解し、
対数変換による分布特性の保持方法を記載します。

---

## 現場で直面する現実

### シナリオ：預金残高計の分布

```
全顧客：100,000 名

預金残高（単位：万円）
- 0-100        万円：80,000名（80%）
- 100-1,000    万円：15,000名（15%）
- 1,000-10,000 万円：4,000名（4%）
- 10,000 万円以上  ：1,000名（1%）

分布：べき分布（Power Law Distribution）
```

### 教科書的アプローチ
```python
# 平均を計算してみると...
mean_balance = 平均残高
std_balance = 標準偏差

# 異常検知ルール：mean ± 3σ を超える → 外れ値と判定
# 削除する...
```

### 何が起きるか？

```
1. プロファイリングされていない異常金融行動
   ↓
   削除しても「本当はそこにいた」
   
2. 高残高層（1%）の顧客特性が失われる
   ↓
   「実は資産家向けマーケティングが最も効果的」
   という知見が得られない
   
3. 不正検知モデルでは、高額詐欺を見逃す
```

---

## なぜべき分布は「外れ値 ≠ ノイズ」なのか

### べき分布の特性

```
一般的な分布（正規分布）：
  ↑
  │  ███
  │  █████
  │ ███████
  │█████████
  └─────────→
  
ほぼ全てが平均付近。
両端は確かに異常。

べき分布（金融データ等）：
  ↑
  │█
  │██
  │ ███
  │  █████
  │   ██████
  │    ███████
  └─────────→
  
「尾が太い」
外れ値のような値もデータとして正当
```

### 金融データでのべき分布の意味

```
「顧客の資産分布」そのもの

- 多くの人は少額（正規分布では異常に見える低い層）
- 少数の人が多額（正規分布では外れ値に見える高額層）

これは「金融システムの本質」
```

---

## 対数変換による解決

### Step 1：対数変換の実施

```python
import numpy as np
import matplotlib.pyplot as plt

# 元データ
balance = df['deposit_balance']

# 対数変換（ただし 0 は -inf になるので避ける）
balance_log = np.log10(balance + 1)  # ← +1 で 0 を回避
```

### Step 2：分布の可視化

```python
# 元の分布
plt.subplot(1, 2, 1)
plt.hist(balance, bins=100)
plt.title("元のべき分布")

# 対数変換後
plt.subplot(1, 2, 2)
plt.hist(balance_log, bins=100)
plt.title("対数変換後（より正規分布に近い）")
plt.show()
```

### Step 3：利点

```
1. 分布が「より正規分布に近く」なる
   → 統計手法の前提が満たされやすい

2. 「尾の太さ」を保持しつつ
   → 高額層の情報は失われない

3. 相対的な比較がしやすくなる
   → 1万円と100万円の差 = 1万円と10万円の差
     として理解できる
```

---

## 実務での適用例

### 例：不正検知モデル

```python
# Before: 外れ値除去
balance_cleaned = balance[(balance > balance.mean() - 3*balance.std()) &
                          (balance < balance.mean() + 3*balance.std())]
# → 高額詐欺ケースが削除される

# After: 対数変換
balance_log = np.log10(balance + 1)
model.fit(balance_log, y_fraud)
# → 高額層の詐欺パターンが学習される
```

### 例：顧客セグメンテーション

```python
# 対数スケールでセグメント分け
segment_thresholds = [0, 3, 5, 6, 8]  # log10 スケール
# = [1, 1000, 100k, 1M, 100M] 円

segments = pd.cut(balance_log, bins=segment_thresholds)
# → 0-1000円層、1k-100k層、100k-1M層... as naturally分布
```

---

## 外れ値の「本当の役割」

### 従来の理解
```
外れ値 = ノイズ = 削除対象
```

### 実務での理解
```
外れ値 = 希少な現象 = 知見源
```

例：
- 高額残高 → 資産層の行動特性
- 短時間での大額振込 → 詐欺パターンの可能性
- 通常と異なる接触パターン → 新規興味分野

これらは「削除」ではなく「分析対象」にするべき

---

## 注意事項

### 対数変換が適さない場合

```
1. ゼロが多い場合
   - log(0) = -inf なので +1 という workaround は本質的ではない
   - Box-Cox変換など別手法を検討

2. 負の値がある場合
   - log は負で定義されない
   - 平行移動やBox-Cox変換を使用

3. 現実の相互作用が線形でない場合
   - 対数変換後も非線形性が残る
```

### 外れ値完全除外の場合

```
- 明らかなデータ入力エラー（年齢が999歳など）
- センサ故障その他明白な技術的ノイズ
- ビジネスロジック上除外される層

は除去して良い
```


## References

- Power Law Distribution: https://en.wikipedia.org/wiki/Power_law
- Log-Normal Distribution: https://en.wikipedia.org/wiki/Log-normal_distribution
- Box-Cox Transformation: https://en.wikipedia.org/wiki/Power_transform

